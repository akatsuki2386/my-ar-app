<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR.jsマーカーテスト</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- A-FrameとAR.jsのライブラリを読み込む -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  </head>

  <body style="margin : 0px; overflow: hidden;">
    <!-- ▼▼▼ 変更点：rendererにphysicallyCorrectLightsを追加 ▼▼▼ -->
    <a-scene embedded renderer="logarithmicDepthBuffer: true; physicallyCorrectLights: true;" arjs="sourceType: webcam; vr-mode-ui: enabled: false; debugUIEnabled: false;">

      <a-marker id="my-marker" type="pattern" url="https://raw.githack.com/AR-js-org/AR.js/master/data/patt.hiro">
        
        <a-box id="test-box" position="0 0.5 0" material="color: red;"></a-box>
        
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // ▼▼▼ 変更点：カメラのズーム問題を修正するための追加処理 ▼▼▼
      window.addEventListener("arjs-video-loaded", () => {
        // ARのビデオが読み込まれたら、強制的にリサイズイベントを発火させる
        // これにより、カメラの投影行列が再計算され、ズームが直ることがある
        setTimeout(() => {
          window.dispatchEvent(new Event("resize"));
          console.log("リサイズイベントを強制実行しました。");
        }, 500); // 500ミリ秒の遅延を持たせる
      });

      document.addEventListener('DOMContentLoaded', () => {
        const marker = document.querySelector("#my-marker");

        marker.addEventListener("markerFound", (e) => {
          console.log("マーカー見つけた！");
          const testBox = document.querySelector("#test-box");
          testBox.setAttribute('material', 'color', 'green');
        });

        marker.addEventListener("markerLost", (e) => {
          console.log("マーカー見失った...");
          const testBox = document.querySelector("#test-box");
          testBox.setAttribute('material', 'color', 'red');
        });
      });
    </script>
  </body>
</html>
