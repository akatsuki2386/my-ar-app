<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR家具配置アプリ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- ライブラリはAR.jsとA-Frameの2つだけ！ -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
      body { margin: 0 !important; overflow: hidden !important; }
      a-scene { height: 100vh; width: 100vw; }
      .clickable { cursor: pointer; }
    </style>

    <script>
      // size-adjusterコンポーネントはそのまま使う
      AFRAME.registerComponent('size-adjuster', {
        schema: { targetHeight: {type: 'number', default: 1} },
        init: function () {
          this.scaled = false;
        },
        tick: function () {
          if (this.el.object3DMap.mesh && !this.scaled) {
            const targetHeight = this.data.targetHeight;
            const mesh = this.el.getObject3D('mesh');
            const box = new THREE.Box3().setFromObject(mesh);
            const size = box.getSize(new THREE.Vector3());
            if (size.y > 0) {
              const scale = targetHeight / size.y;
              this.el.setAttribute('scale', { x: scale, y: scale, z: scale });
              this.scaled = true;
            }
          }
        }
      });
    </script>
  </head>

  <body>
    <a-scene 
      id="ar-scene"
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="logarithmicDepthBuffer: true;"
      cursor="rayOrigin: mouse; fuse: false;"
      raycaster="objects: .clickable">

      <a-marker id="hiro-marker" preset="hiro">
        <a-gltf-model 
          id="marker-chair"
          class="clickable"
          src="chair.glb" 
          position="0 0 0"
          size-adjuster="targetHeight: 0.79">
        </a-gltf-model>
      </a-marker>
      
      <a-entity camera></a-entity>
    </a-scene>

    <!-- ▼▼▼ 変更点：「イス解放作戦」を実行する新しいロジック！ ▼▼▼ -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const sceneEl = document.querySelector('#ar-scene');
        const markerChair = document.querySelector('#marker-chair');

        // マーカーのイスがタップされた時の処理
        markerChair.addEventListener('click', () => {
          // すでに配置済みのイスがあれば、何もしない（複数配置を防ぐ）
          if (document.querySelector('.placed-chair')) {
            console.log('すでにイスは配置されています。');
            return;
          }
          
          console.log('イスをマーカーから解放します！');

          // --- 新しいイスを、マーカーの場所にコピーして作る ---
          const placedChair = document.createElement('a-entity'); // 位置と回転を保持する空の親を作る
          const newChairModel = document.createElement('a-gltf-model');

          // 1. マーカーの現在の世界での位置と回転を取得
          const worldMatrix = markerChair.object3D.matrixWorld;
          
          // 2. 新しい親（placedChair）に、その位置と回転を適用
          placedChair.object3D.applyMatrix4(worldMatrix);

          // 3. 新しいイスのモデル情報を設定
          newChairModel.setAttribute('src', 'chair.glb');
          newChairModel.setAttribute('size-adjuster', 'targetHeight: 0.79');
          // ★重要：親に対しての位置は(0,0,0)にする
          newChairModel.setAttribute('position', '0 0 0'); 

          // 4. 親にイスのモデルを追加
          placedChair.appendChild(newChairModel);
          // 5. 親にクラス名をつけて、後で識別できるようにする
          placedChair.classList.add('placed-chair');

          // 6. 親（アンカー）をシーンに追加する
          sceneEl.appendChild(placedChair);

          // 7. 元のマーカーのイスは隠す
          markerChair.setAttribute('visible', 'false');

          console.log('イスをその場に固定しました。');
        });
      });
    </script>
  </body>
</html>
```

### どこを変えたか

前回のアンカー方式と似てるけど、**「何をコピーして、どこに入れるか」**をより正確にしたんだ。

1.  **空の親（`placedChair`）を作る**
    * いきなりイスを置くんじゃなくて、まずその場所を記憶するための、目に見えない空っぽの箱を準備する。

2.  **マーカーの位置と回転を、まるごと親にコピー**
    * `applyMatrix4`っていう魔法で、マーカーが今いる場所と、向いてる向きの情報を、まるごと空の親にコピーする。

3.  **親をシーンに置く**
    * これで、親が世界のその場所にガッチリ固定される。

4.  **親の中に、新しいイスを入れる**
    * 固定された親の中に、新しいイスを置く。こうすることで、イスは親を基準にして表示されるから、座標が絶対にズレない！

5.  **元のマーカーのイスを隠す**
    * 最後に、お役御免になったマーカーの上のイスを隠す。

### これでどうなるはずか？

1.  床に置いたマーカーを写すと、イスが表示される。
2.  その**イスをタップ**する。
3.  タップした**その場所に、新しいイスがドン！と置かれる**。
4.  その後は、**マーカーを動かしても、新しく置かれたイスはその場に残り続ける**！
5.  （一回しか置けないようにしてある）

君のアイデアのおかげで、ついにこの問題のゴールが見えた！
これが最後の正直だ！試してみて
